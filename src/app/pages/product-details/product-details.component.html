<div class="product-details-page">
    <div class="product-page-container" *ngIf="product; else loading">

        <div class="details-header">
            <div class="back-button" (click)="goBack()">
                <i class="fas fa-arrow-left"></i> BACK
            </div>
            <div class="model-indicator" *ngIf="has3DModel">
                <i class="fas fa-cube"></i>
                <span>3D VIEW</span>
            </div>
        </div>

        <div class="product-content">
            <!-- Left: Product Gallery -->
            <div class="product-gallery">
                <!-- 3D Model Section - WITH BACKGROUND -->
                <div *ngIf="has3DModel && show3DView" class="model-container">
                    <div class="model-viewer-wrapper">
                        <app-model-viewer 
                            [modelPath]="product.images[0]"
                            [autoRotate]="isRotating"
                            [autoScale]="true"
                            [targetSize]="12"
                            [addStreetBackground]="true"> <!-- IMPORTANT: AjoutÃ© ici -->
                        </app-model-viewer>
                        
                        <!-- Background Toggle Button -->
                        <div class="background-toggle">
                            <button class="bg-toggle-btn" (click)="toggleBackground()" 
                                    [class.active]="addStreetBackground">
                                <i class="fas" [class.fa-city]="addStreetBackground" 
                                           [class.fa-mountain]="!addStreetBackground"></i>
                                <span>{{ addStreetBackground ? 'STREET VIEW' : 'STUDIO VIEW' }}</span>
                            </button>
                        </div>

                        <div class="model-controls">
                            <button class="model-btn" >
                                <i class="fas" [class.fa-pause]="!isRotating" [class.fa-sync-alt]="isRotating"></i>
                                {{isRotating ? 'PAUSE' : 'ROTATE'}}
                            </button>
                            <button class="model-btn" >
                                <i class="fas fa-palette"></i>
                                COLOR
                            </button>
                            <button class="model-btn">
                                <i class="fas fa-undo"></i>
                                RESET
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Regular Image Section -->
                <div *ngIf="!has3DModel || !show3DView" class="main-image-container">
                    <div class="gta-bg-elements">
                        <div class="bg-panel panel-1"></div>
                        <div class="bg-panel panel-2"></div>
                        <div class="bg-panel panel-3"></div>
                    </div>
                    <img [src]="getCurrentImage()" [alt]="product.name" class="main-image">
                </div>

                <!-- View Toggle & Thumbnails -->
                <div class="gallery-controls">
                    <!-- View Toggle -->
                    <div class="view-toggle" *ngIf="has3DModel">
                        <button class="view-btn" 
                                [class.active]="show3DView" 
                                (click)="show3DView = true">
                            <i class="fas fa-cube"></i>
                            <span>3D VIEW</span>
                        </button>
                        <button class="view-btn" 
                                [class.active]="!show3DView" 
                                (click)="show3DView = false">
                            <i class="fas fa-image"></i>
                            <span>IMAGE</span>
                        </button>
                    </div>

                    <!-- Image Thumbnails -->
                    <div class="thumbnail-gallery" *ngIf="!show3DView && product.images.length > 1">
                        <div class="thumbnail" 
                             *ngFor="let image of getImageThumbnails(); let i = index"
                             [class.active]="selectedImageIndex === i"
                             (click)="selectImage(i)">
                            <img [src]="image" [alt]="product.name + ' thumbnail ' + (i+1)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Product Info -->
            <div class="product-info-panel">
                <span class="product-brand">{{product.brand}} // {{product.category}}</span>
                <h1 class="product-title">{{product.name}}</h1>

                <div class="product-meta">
                    <div class="price-tag">
                        <span class="currency">$</span>{{product.price}}
                        <span class="original-price" *ngIf="product.originalPrice">${{product.originalPrice}}</span>
                    </div>
                    <div class="rating">
                        <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                            [style.opacity]="star <= product.rating ? 1 : 0.3"></i>
                        <span>({{product.reviewCount}} REVIEWS)</span>
                    </div>
                </div>

                <p class="product-description">{{product.description}}</p>

                <!-- Product Specs -->
                <div class="product-specs" *ngIf="product.material">
                    <div class="spec-item">
                        <span class="spec-label">MATERIAL:</span>
                        <span class="spec-value">{{product.material}}</span>
                    </div>
                    <div class="spec-item" *ngIf="has3DModel">
                        <span class="spec-label">VIEW:</span>
                        <span class="spec-value">3D Model Available</span>
                    </div>
                    <div class="spec-item" *ngIf="has3DModel">
                        <span class="spec-label">BACKGROUND:</span>
                        <span class="spec-value">{{ addStreetBackground ? 'Street View' : 'Studio View' }}</span>
                    </div>
                </div>

                <div class="options-container">
                    <!-- Size Selector -->
                    <div class="option-group" *ngIf="product.sizes?.length">
                        <h3>SELECT SIZE</h3>
                        <div class="option-chips">
                            <div class="chip" *ngFor="let size of product.sizes"
                                [class.selected]="selectedSize === size" (click)="selectSize(size)">
                                {{size}}
                            </div>
                        </div>
                    </div>

                    <!-- Color Selector -->
                    <div class="option-group" *ngIf="product.colors?.length">
                        <h3>SELECT COLOR</h3>
                        <div class="option-chips">
                            <div class="chip" *ngFor="let color of product.colors"
                                [class.selected]="selectedColor === color" (click)="selectColor(color)">
                                {{color}}
                            </div>
                        </div>
                    </div>

                    <!-- Background Selector -->
                    <div class="option-group" *ngIf="has3DModel">
                        <h3>3D BACKGROUND</h3>
                        <div class="option-chips">
                            <div class="chip" [class.selected]="addStreetBackground" (click)="addStreetBackground = true">
                                STREET
                            </div>
                            <div class="chip" [class.selected]="!addStreetBackground" (click)="addStreetBackground = false">
                                STUDIO
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="gta-btn primary-btn" (click)="$event.stopPropagation(); addToCart(product)"
                            [disabled]="!product.inStock">
                        <i class="fas fa-shopping-cart"></i> 
                        {{product.inStock ? 'ADD TO CART' : 'OUT OF STOCK'}}
                    </button>
                    <button class="gta-btn secondary-btn" (click)="tryOn()">
                        <i class="fas fa-camera"></i> TRY ON
                    </button>
                </div>

                <!-- 3D Info -->
                <div class="model-info" *ngIf="has3DModel">
                    <div class="info-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="info-text">
                        <h4>3D INTERACTIVE VIEW</h4>
                        <p>Rotate, zoom, and change colors of this product in 3D. Click and drag to explore.</p>
                        <p class="bg-info" *ngIf="addStreetBackground">
                            <i class="fas fa-map-marker-alt"></i>
                            Viewing in Street Mode with graffiti background
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ng-template #loading>
        <div class="loading-state">
            <div class="spinner"></div>
            <p>LOADING PRODUCT DATA...</p>
        </div>
    </ng-template>
</div>
<app-bottom-nav></app-bottom-nav>